<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Looplet</title>
<link rel="icon" type="image/png" href="looplet.png"/>
<style>
  :root { --bg:#0b0f14; --fg:#e9eef3; --muted:#aab6c4; --card:#101722; --line:#1c2634; --accent:#1367d6; }
  *{box-sizing:border-box}
  html,body{height:100%;overflow-x:hidden}
  body{margin:0;background:linear-gradient(180deg,#0b0f14,#0c1117);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:18px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
  .logo-title{display:flex;align-items:center;gap:10px}
  .logo-title img{height:22px}
  .navlink a{color:#9ec5ff;text-decoration:none;font-size:14px}
  main{max-width:1400px;margin:20px auto;padding:0 0 32px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.25);margin:0 14px 14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row-split{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .stack{display:grid;gap:12px}
  label{font-size:14px;color:var(--muted)}
  select,button.primary{height:40px;border-radius:10px;border:1px solid var(--line);background:#0f1520;color:var(--fg);padding:0 12px}
  button.primary{background:linear-gradient(180deg,#2480ff,#1367d6);border:none;box-shadow:0 6px 18px rgba(19,103,214,.35);font-weight:600}
  input[type="range"]{width:100%}
  .muted{color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:1fr auto;gap:10px}
  @media (max-width:560px){ .grid{grid-template-columns:1fr} }

  .thumb-grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:0;overflow:hidden}
  @media (max-width:1200px){.thumb-grid{grid-template-columns:repeat(4,1fr)}}
  @media (max-width:960px){.thumb-grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:680px){.thumb-grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:420px){.thumb-grid{grid-template-columns:1fr}}

  .thumb{position:relative;display:block;width:100%;border:0;margin:0;padding:0;background:#0e1520;cursor:pointer;line-height:0;aspect-ratio:3/2;overflow:hidden;transition:transform .22s,box-shadow .22s}
  .thumb:hover{transform:translateY(-2px) scale(1.02);box-shadow:0 10px 28px rgba(0,0,0,.35)}
  .thumb-img,.thumb-preview{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
  .thumb-preview{opacity:0;transition:opacity .18s;pointer-events:none}

  @keyframes shimmer{0%{background-position:-120% 0}100%{background-position:120% 0}}
  .thumb--loading{background:linear-gradient(90deg,#0e1520 0,#172235 48%,#0e1520 100%);background-size:200% 100%;animation:shimmer 1.1s infinite linear}

  /* Audio progress bar */
  .loopbar{position:relative;height:14px;background:#0f1520;border:1px solid var(--line);border-radius:999px;overflow:hidden;cursor:pointer}
  .loopbar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#3aa1ff,#8ab5ff);transition:width .08s linear}
  .loopbar.seeking>span{transition:none}

  /* Fullscreen stage */
  #videoStage{position:fixed;inset:0;background:black;opacity:0;pointer-events:none;z-index:9999;transition:opacity .25s ease}
  #videoStage.show{opacity:1;pointer-events:auto}
  #bgVideo,#bgImage{position:absolute;width:100vw;height:100vh;object-fit:cover;inset:0}
  #bgImage{display:none}

  /* Input-capture layer to prevent tap-through */
  #hitLayer{position:absolute;inset:0;z-index:5;background:transparent;touch-action:none;cursor:pointer}

  /* Edge hover hints for mouse users */
  .edgeHint{
    position:absolute; top:0; bottom:0; width:22%;
    display:flex; align-items:center; justify-content:center;
    color:#e9eef3; font-size:38px; opacity:0; pointer-events:none;
    transition:opacity .18s ease;
    text-shadow:0 6px 20px rgba(0,0,0,.7);
  }
  #edgeLeft{left:0;}
  #edgeRight{right:0;}
  #videoStage.show.mouse-hovering .edgeHint{opacity:.22}
  #videoStage.show.mouse-hovering .edgeHint.edge-active{opacity:.6}

  /* Tags */
  .tags-bar{display:flex;flex-wrap:wrap;gap:8px}
  .tag{border:1px solid var(--line);background:#0f1520;color:var(--fg);padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}
  .tag.active{border-color:var(--accent);box-shadow:0 0 0 1px #2480ff55 inset}
  .pill{display:inline-flex;align-items:center;gap:8px}
  .switch{display:inline-flex;align-items:center;gap:8px;color:var(--muted);font-size:13px}
  .switch input{appearance:none;width:42px;height:24px;border-radius:999px;border:1px solid var(--line);background:#223044;position:relative;cursor:pointer}
  .switch input::after{content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:.2s}
  .switch input:checked{background:#1367d6}.switch input:checked::after{left:calc(100% - 22px)}
</style>
</head>
<body>
<header>
  <div class="logo-title"><img src="looplet.png" alt=""/><h1>Looplet</h1></div>
  <div class="navlink"><a href="creator.html">→ Creator</a></div>
</header>

<main>
  <!-- Audio -->
  <section class="card stack">
    <div class="stack">
      <label for="fileSelect">Audio</label>
      <div class="grid" style="margin:0 0 6px">
        <select id="fileSelect"><option value="" selected>— Select a track —</option></select>
        <button id="btnToggle" class="primary" disabled>Pause</button>
      </div>
      <div class="row" style="justify-content:space-between"><label for="masterVol">Volume</label><input id="masterVol" type="range" min="0" max="1" step="0.001" value="0.8"/></div>
      <div class="row" style="justify-content:space-between"><label id="pitchLabel" for="pitch">Pitch (0.00 st)</label><input id="pitch" type="range" min="-12" max="12" step="0.01" value="0" list="pitchTicks"/></div>
      <datalist id="pitchTicks"><option value="0"></option></datalist>
      <div id="nowPlaying" class="muted"></div>
      <div id="loopBar" class="loopbar" aria-label="Seek within loop"><span id="loopBarFill"></span></div>
    </div>
  </section>

  <!-- Gallery -->
  <section class="card stack" style="margin-top:14px;padding:0">
    <div class="row-split" style="padding:14px 14px 6px">
      <div class="stack" style="gap:6px">
        <label>Animations (filter by tags)</label>
        <div class="pill muted">Logic:
          <select id="tagLogic" style="height:auto;padding:6px 8px;border-radius:8px;background:#0f1520;color:var(--fg);border:1px solid var(--line)">
            <option value="and">AND</option><option value="or">OR</option>
          </select>
        </div>
        <div id="tagsBar" class="tags-bar"></div>
      </div>
      <label class="switch" title="Cycle at each audio loop start"><input type="checkbox" id="syncToggle"/> Sync</label>
    </div>
    <div id="videoGrid" class="thumb-grid" aria-live="polite"></div>
    <div class="muted" style="padding:8px 14px 14px">Tip: click a thumb to open fullscreen. Use ←/→ or swipe. Filters affect cycling.</div>
  </section>

  <div id="error" class="muted" style="color:#ffb4b4;margin:12px 14px"></div>
</main>

<!-- Fullscreen stage -->
<div id="videoStage" tabindex="0" aria-label="Fullscreen">
  <video id="bgVideo" playsinline muted loop></video>
  <img id="bgImage" alt="" decoding="async"/>
  <div id="hitLayer" title="Tap to exit"></div>
  <div id="edgeLeft"  class="edgeHint">◀</div>
  <div id="edgeRight" class="edgeHint">▶</div>
</div>

<script>
/* ===== API endpoints (DB-backed) ===== */
const API_LIST = kind => `/api/media?kind=${encodeURIComponent(kind)}`;
const AUDIO_BASE = '/audio/';
const VIDEO_BASE = '/video/';

/* ===== helpers ===== */
const isGif = u => /\.gif(\?|#|$)/i.test(u);
const sleep = ms => new Promise(r=>setTimeout(r,ms));

/* ===== audio core (with progress meter & seeking) ===== */
const AudioContextClass=window.AudioContext||window.webkitAudioContext;
const audioCtx=new AudioContextClass({latencyHint:"interactive"});
const masterGain=audioCtx.createGain(); masterGain.gain.value=0.8; masterGain.connect(audioCtx.destination);
const VIZ_FUDGE_SEC=0.020, QUICK_FADE=40, FADE_MS=60;
function rampParam(p,t,ms=60){const now=audioCtx.currentTime,d=Math.max(.001,ms/1000);p.cancelScheduledValues(now);p.setValueAtTime(p.value,now);p.linearRampToValueAtTime(t,now+d);}
function rateFromSemi(s){return Math.pow(2,s/12);}

class LoopPlayer{
  constructor(item){this.item=item;this.buffer=null;this.src=null;this.gain=audioCtx.createGain();this.gain.gain.value=1.0;this.gain.connect(masterGain);this.playing=false;this.loading=false;this.startTime=0;this.paused=false;this.pausedPos=0;}
  async ensureLoaded(){ if(this.buffer||this.loading) return; this.loading=true; try{const r=await fetch(this.item.url); if(!r.ok) throw new Error('HTTP '+r.status); const arr=await r.arrayBuffer(); this.buffer=await audioCtx.decodeAudioData(arr);} finally{this.loading=false;} }
  start(offSec=0){ if(!this.buffer) return; this.src=audioCtx.createBufferSource(); this.src.buffer=this.buffer; this.src.loop=true; this.src.playbackRate.value=pitchRate; this.src.connect(this.gain); const t0=audioCtx.currentTime+0.02; const dur=this.buffer.duration||0; const off=dur?((offSec%dur)+dur)%dur:0; try{this.src.start(t0,off);}catch{this.src.start(t0);} this.startTime=t0-(off/pitchRate); this.playing=true; this.paused=false; this.pausedPos=off; }
  stop(){ if(this.src){try{this.src.stop();}catch{} try{this.src.disconnect();}catch{} this.src=null;} this.playing=false; this.startTime=0; }
  async play(){ await this.ensureLoaded(); if(!this.playing) this.start(0); }
  async pause(){ if(!this.buffer||!this.src){this.paused=true;return;} const rate=this.src.playbackRate.value||1; const dur=this.buffer.duration||0; if(dur>0){const now=audioCtx.currentTime; const elapsed=(now-this.startTime)*rate; this.pausedPos=((elapsed%dur)+dur)%dur;} else this.pausedPos=0; rampParam(this.gain.gain,0,QUICK_FADE); await sleep(QUICK_FADE+5); if(this.src){try{this.src.stop();}catch{} try{this.src.disconnect();}catch{} this.src=null;} this.playing=false; this.paused=true; }
  async resume(){ if(!this.buffer) return; const pos=this.pausedPos||0; this.start(pos); rampParam(this.gain.gain,1,QUICK_FADE); }
  async seekToFraction(fr){ if(!this.buffer) return; const dur=this.buffer.duration||0; const target=Math.max(0,Math.min(1,fr))*dur; const was=this.playing&&this.src; if(was){rampParam(this.gain.gain,0,FADE_MS); await sleep(FADE_MS+10);} if(this.src){try{this.src.stop();}catch{} try{this.src.disconnect();}catch{} this.src=null;} this.start(target); if(was) rampParam(this.gain.gain,1,FADE_MS); this.pausedPos=target; }
}

const $select=document.getElementById('fileSelect');
const $toggle=document.getElementById('btnToggle');
const $vol=document.getElementById('masterVol');
const $np=document.getElementById('nowPlaying');
const $loopBar=document.getElementById('loopBar');
const $loopFill=document.getElementById('loopBarFill');
const $pitch=document.getElementById('pitch');
const $pitchLabel=document.getElementById('pitchLabel');
const $err=document.getElementById('error');

function setNowPlaying(txt){$np.textContent=txt?`Now playing: ${txt}`:'';}
let current=null, lastPct=0, seeking=false, pitchSemitones=0, pitchRate=1;
function setFill(p){const pct=Math.max(0,Math.min(1,p));$loopFill.style.width=(pct*100).toFixed(1)+'%';}
function vizTick(){ if(current&&current.buffer){ if(!seeking&&current.playing){ const rate=(current.src?.playbackRate?.value||1); const dur=current.buffer.duration/rate; if(dur>0){ const t=(audioCtx.currentTime-current.startTime)%dur; lastPct=Math.max(0,Math.min(1,t/dur)); } } setFill(lastPct);} requestAnimationFrame(vizTick); }
requestAnimationFrame(vizTick);
function pctFromClientX(x){const r=$loopBar.getBoundingClientRect(); return Math.max(0,Math.min(1,(x-r.left)/r.width));}
function beginSeek(x){seeking=true;$loopBar.classList.add('seeking'); lastPct=pctFromClientX(x); setFill(lastPct);}
async function commitSeek(x){ if(!seeking) return; seeking=false;$loopBar.classList.remove('seeking'); lastPct=pctFromClientX(x); setFill(lastPct); if(current) await current.seekToFraction(lastPct); resyncScheduler();}
function moveSeek(x){ if(!seeking) return; lastPct=pctFromClientX(x); setFill(lastPct);}
$loopBar.addEventListener('pointerdown',e=>{e.preventDefault();$loopBar.setPointerCapture?.(e.pointerId);beginSeek(e.clientX)});
$loopBar.addEventListener('pointermove',e=>{if(seeking){e.preventDefault();moveSeek(e.clientX)}});
$loopBar.addEventListener('pointerup',e=>{e.preventDefault();commitSeek(e.clientX)});
$loopBar.addEventListener('pointercancel',()=>{seeking=false;$loopBar.classList.remove('seeking')});

function setPitchSemitones(semi){
  pitchSemitones=semi; pitchRate=rateFromSemi(semi);
  if($pitchLabel) $pitchLabel.textContent=`Pitch (${semi>=0?'+':''}${semi.toFixed(2)} st)`;
  if(current&&current.buffer&&current.src){
    const now=audioCtx.currentTime; const old=current.src.playbackRate.value||1; const dur=current.buffer.duration||0; let pos=0;
    if(dur>0){pos=((now-current.startTime)*old)%dur;}
    current.src.playbackRate.value=pitchRate;
    if(dur>0){current.startTime=now-(pos/pitchRate);}
    resyncScheduler();
  }
}
$pitch.addEventListener('input',()=>setPitchSemitones(parseFloat($pitch.value)));
$pitch.addEventListener('change',()=>{const v=parseFloat($pitch.value||'0'); if(Math.abs(v)<=0.08){$pitch.value='0'; setPitchSemitones(0);}});
$pitch.addEventListener('dblclick',()=>{$pitch.value=0; setPitchSemitones(0);});
setPitchSemitones(parseFloat($pitch.value||0));

async function playSelection(url){
  if(!url) return;
  try{
    if(current){rampParam(masterGain.gain,0,FADE_MS); await sleep(FADE_MS+10); current.stop(); masterGain.gain.value=$vol.value;}
    await audioCtx.resume();
    current=new LoopPlayer({url});
    await current.play();
    lastPct=0; setFill(0);
    masterGain.gain.value=0.0; rampParam(masterGain.gain,Number($vol.value),FADE_MS);
    setNowPlaying($select.selectedOptions[0]?.textContent || '');
    $toggle.disabled=false; $toggle.textContent='Pause';
    resyncScheduler();
  }catch(e){ $err.textContent = String(e.message||e); }
}
async function toggleAudioPlayPause(){ if($toggle.disabled||!current) return; if(current.playing){await current.pause(); $toggle.textContent='Resume';} else {await current.resume(); $toggle.textContent='Pause';} resyncScheduler(); }
$select.addEventListener('change',()=>playSelection($select.value));
$toggle.addEventListener('click',toggleAudioPlayPause);
document.addEventListener('keydown',async e=>{const isSpace=e.code==='Space'||e.key===' '; if(!isSpace) return;
  const t=e.target,tag=(t&&t.tagName||'').toLowerCase(); if(t?.isContentEditable||['input','textarea','select','button'].includes(tag)) return;
  e.preventDefault(); await toggleAudioPlayPause();
});
$vol.addEventListener('input',e=>rampParam(masterGain.gain,Number(e.target.value),60));

/* ===== scheduler for sync-cycling ===== */
const $syncToggle=document.getElementById('syncToggle');
let schedTimer=null,schedToken=0,lastAdvancedCycle=-1;
function cancelScheduler(){ if(schedTimer){clearTimeout(schedTimer);schedTimer=null;} schedToken++; }
function shouldSync(){ return $syncToggle.checked && $videoStage.classList.contains('show') && current && current.playing && current.buffer; }
function getDur(){ if(!current||!current.buffer||!current.src) return 0; const rate=current.src.playbackRate?.value||1; return current.buffer.duration/rate; }
function getCycleNow(){ const dur=getDur(); if(!(dur>0)) return -1; return Math.floor(((audioCtx.currentTime-current.startTime)+0.0005)/dur); }
function audibleLatencySec(){let l=0; if(typeof audioCtx.baseLatency==='number') l+=audioCtx.baseLatency; if(typeof audioCtx.outputLatency==='number') l+=audioCtx.outputLatency; if(!(l>0)) l=0.03; return Math.max(0,Math.min(0.35,l+VIZ_FUDGE_SEC));}
function scheduleNextBoundary(){
  cancelScheduler(); if(!shouldSync()) return; const dur=getDur(); if(!(dur>0)) return;
  const now=audioCtx.currentTime; const cycleNow=getCycleNow(); const nextCycle=Math.max(cycleNow+1,lastAdvancedCycle+1);
  const nextRenderTime=current.startTime+nextCycle*dur; const fireAt=nextRenderTime+audibleLatencySec(); const delay=Math.max(5,(fireAt-now)*1000); const tok=schedToken;
  schedTimer=setTimeout(()=>{ if(tok!==schedToken) return; if(!shouldSync()){scheduleNextBoundary();return;} const cNow=getCycleNow(); if(cNow>=nextCycle && cNow>lastAdvancedCycle){ lastAdvancedCycle=cNow; showStageAt(STAGE_INDEX+1,'auto'); } scheduleNextBoundary(); },delay);
}
function resyncScheduler(){ cancelScheduler(); if(!shouldSync()) return; lastAdvancedCycle=getCycleNow(); scheduleNextBoundary(); }
$syncToggle.addEventListener('change',resyncScheduler);

/* ===== fullscreen viewer (tap-through safe + keyboard/swipe + edge click) ===== */
const $videoStage=document.getElementById('videoStage');
const $bgVideo=document.getElementById('bgVideo');
const $bgImage=document.getElementById('bgImage');
const $hitLayer=document.getElementById('hitLayer');
const $edgeLeft=document.getElementById('edgeLeft');
const $edgeRight=document.getElementById('edgeRight');
let savedScrollY=0, STAGE_LIST=[], STAGE_INDEX=-1, LIB_ITEMS=[], FILTERED_ITEMS=[];

/* Guard against ghost-clicks after closing */
let GHOST_BLOCK_UNTIL = 0;
document.addEventListener('click', (e)=>{
  if (Date.now() < GHOST_BLOCK_UNTIL) {
    e.preventDefault(); e.stopPropagation();
  }
}, true);

function stopAllThumbPreviews(){
  document.querySelectorAll('.thumb-preview').forEach(el=>{
    el.style.opacity='0';
    if(el.tagName==='VIDEO'){try{el.pause();}catch{} el.removeAttribute('src'); el.load();}
    else {el.removeAttribute('src');}
  });
}
function stopVideo(){
  try{$bgVideo.pause();}catch{}
  $bgVideo.removeAttribute('src'); $bgVideo.load();
  $bgImage.removeAttribute('src'); $bgImage.style.display='none';
  $videoStage.classList.remove('show');
  document.body.style.overflow='';
  cancelScheduler();
  GHOST_BLOCK_UNTIL = Date.now() + 250;
  requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo(0,savedScrollY);});});
}
function playUrlInStage(url){
  return new Promise(async (resolve,reject)=>{
    try{
      savedScrollY=window.scrollY||document.documentElement.scrollTop||0;
      stopAllThumbPreviews();
      if(isGif(url)){
        $bgImage.src=url; $bgImage.style.display='block'; $bgVideo.style.display='none';
      } else {
        $bgImage.removeAttribute('src'); $bgImage.style.display='none';
        $bgVideo.src=url; $bgVideo.muted=true; $bgVideo.loop=true; $bgVideo.playsInline=true; $bgVideo.style.display='block';
        await $bgVideo.play().catch(()=>{});
      }
      $videoStage.classList.add('show');
      document.body.style.overflow='hidden';
      $videoStage.focus({preventScroll:true});
      resolve();
    }catch(e){ reject(e); }
  });
}
function openFileInStage(item){
  STAGE_LIST=FILTERED_ITEMS.slice();
  const idx=STAGE_LIST.findIndex(x=>x.url===item.url);
  STAGE_INDEX=Math.max(0,idx);
  showStageAt(STAGE_INDEX,'manual');
}
function showStageAt(i){
  if(!STAGE_LIST.length) return;
  STAGE_INDEX=(i%STAGE_LIST.length+STAGE_LIST.length)%STAGE_LIST.length;
  const it=STAGE_LIST[STAGE_INDEX];
  playUrlInStage(it.url).then(()=>{ lastAdvancedCycle=getCycleNow(); resyncScheduler(); }).catch(()=>{ stopVideo(); });
}

/* swipe + tap/edge-click capture on hitlayer */
const SWIPE_X=50, MAX_Y=80, TAP_TIME=500;
let gActive=false, gStartX=0, gStartY=0, gStartT=0;

function begin(x,y){ gActive=true; gStartX=x; gStartY=y; gStartT=Date.now(); }
function end(e){
  if(!gActive) return;
  const x=e.clientX, y=e.clientY, dx=x-gStartX, dy=y-gStartY, dt=Date.now()-gStartT;
  gActive=false;

  const isMouse = (e.pointerType === 'mouse');
  const vw = window.innerWidth||document.documentElement.clientWidth||800;
  const leftEdge = x < vw*0.25, rightEdge = x > vw*0.75;
  const isTap = (dt<=TAP_TIME && Math.abs(dx)<10 && Math.abs(dy)<10);

  if (Math.abs(dx)>=SWIPE_X && Math.abs(dy)<=MAX_Y){
    if(dx<0) showStageAt(STAGE_INDEX+1,'manual'); else showStageAt(STAGE_INDEX-1,'manual');
  } else if (isTap){
    if (isMouse && (leftEdge || rightEdge)){
      if (rightEdge) showStageAt(STAGE_INDEX+1,'manual');
      else showStageAt(STAGE_INDEX-1,'manual');
    } else {
      stopVideo();
    }
  } else {
    stopVideo();
  }
}

$hitLayer.addEventListener('pointerdown',e=>{
  e.preventDefault(); e.stopPropagation();
  try{$hitLayer.setPointerCapture(e.pointerId);}catch{}
  begin(e.clientX,e.clientY);
},{passive:false,capture:true});

$hitLayer.addEventListener('pointerup',e=>{
  e.preventDefault(); e.stopPropagation();
  end(e);
},{passive:false,capture:true});

$hitLayer.addEventListener('pointercancel',e=>{e.preventDefault(); e.stopPropagation(); gActive=false;},{passive:false,capture:true});
$hitLayer.addEventListener('pointermove',e=>{e.preventDefault(); e.stopPropagation();},{passive:false,capture:true});

/* Edge hover hints for mouse */
let mouseOverStage=false;
$videoStage.addEventListener('mouseenter',()=>{ mouseOverStage=true; $videoStage.classList.add('mouse-hovering'); });
$videoStage.addEventListener('mouseleave',()=>{ mouseOverStage=false; $videoStage.classList.remove('mouse-hovering'); $edgeLeft.classList.remove('edge-active'); $edgeRight.classList.remove('edge-active'); });
$videoStage.addEventListener('mousemove',e=>{
  if(!mouseOverStage) return;
  const x=e.clientX, vw=window.innerWidth||document.documentElement.clientWidth||800;
  const left = x<vw*0.25, right = x>vw*0.75;
  $edgeLeft.classList.toggle('edge-active', left);
  $edgeRight.classList.toggle('edge-active', right);
});

/* also allow keyboard */
document.addEventListener('keydown',e=>{
  if(!$videoStage.classList.contains('show')) return;
  if(e.key==='ArrowRight'){e.preventDefault();showStageAt(STAGE_INDEX+1);}
  else if(e.key==='ArrowLeft'){e.preventDefault();showStageAt(STAGE_INDEX-1);}
  else if(e.key==='Escape'){e.preventDefault();stopVideo();}
});

/* ===== thumbnails (lazy) ===== */
function drawFallbackThumb(){ const c=document.createElement('canvas'); c.width=600; c.height=400; const g=c.getContext('2d'); const grd=g.createLinearGradient(0,0,0,400); grd.addColorStop(0,'#19253a'); grd.addColorStop(1,'#0f1520'); g.fillStyle=grd; g.fillRect(0,0,c.width,c.height); return c.toDataURL('image/png'); }
function gifThumb(url){ return new Promise((res,rej)=>{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ try{ const c=document.createElement('canvas'); const w=img.naturalWidth||600,h=img.naturalHeight||400; c.width=600; c.height=Math.round(h*(c.width/w)); c.getContext('2d').drawImage(img,0,0,c.width,c.height); res(c.toDataURL('image/png')); }catch(e){rej(e)} }; img.onerror=()=>rej(new Error('gif thumb error')); img.src=url+(url.includes('?')?'&':'?')+'t='+Date.now(); setTimeout(()=>rej(new Error('gif timeout')),8000); }); }
function videoThumb(url){
  return new Promise((res, rej)=>{
    const v=document.createElement('video'); v.preload='metadata'; v.muted=true; v.playsInline=true; v.crossOrigin='anonymous'; v.src=url;
    let tmo=setTimeout(()=>fail(new Error('thumb timeout')),10000);
    const cleanup=()=>{v.onerror=null; v.onloadedmetadata=null; v.onseeked=null; clearTimeout(tmo);};
    const fail=e=>{try{v.pause();}catch{} v.removeAttribute('src'); v.load(); cleanup(); rej(e||new Error('thumb error'));};
    function grab(){ const c=document.createElement('canvas'); const w=v.videoWidth||600,h=v.videoHeight||400; if(!w||!h) throw new Error('no dims'); c.width=600; c.height=Math.round(h*(c.width/w)); const g=c.getContext('2d'); g.drawImage(v,0,0,c.width,c.height); const data=c.getContext('2d').getImageData(0,0,c.width,c.height).data; let dark=0; for(let i=0;i<1000;i++){const idx=(Math.floor(Math.random()*(data.length/4)))*4; const lum=0.2126*data[idx]+0.7152*data[idx+1]+0.0722*data[idx+2]; if(lum<8) dark++;} const mostlyBlack=(dark/1000)>0.85; return {url:c.toDataURL('image/jpeg',0.9),mostlyBlack}; }
    v.onerror=()=>fail(new Error('video error'));
    v.onloadedmetadata=()=>{ const dur=Math.max(1,v.duration||6); const pts=[Math.min(dur*0.15,2),Math.min(dur*0.4,5),Math.min(dur*0.7,Math.max(1,dur-0.5))]; let i=0;
      const step=()=>{ if(i>=pts.length){ try{const r=grab(); cleanup(); res(r.url);}catch(e){fail(e)} return; }
        const t=pts[i++]; v.onseeked=()=>{ try{const r=grab(); if(!r.mostlyBlack){cleanup(); res(r.url);} else step(); }catch(e){ step(); } };
        try{ v.currentTime=Math.min(Math.max(0,t),v.duration||t); }catch{ step(); }
      }; step();
    };
  });
}
function attachHoverPreview(btn,item){
  let pv=isGif(item.url)?new Image():document.createElement('video');
  if(pv.tagName==='VIDEO'){pv.muted=true;pv.loop=true;pv.playsInline=true;pv.preload='metadata';}
  pv.className='thumb-preview'; btn.appendChild(pv);
  const start=()=>{ pv.style.opacity='1'; if(!pv.src) pv.src=item.url; if(pv.tagName==='VIDEO'){ try{pv.currentTime=0.15;}catch{} pv.play().catch(()=>{});} };
  const stop =()=>{ pv.style.opacity='0'; if(pv.tagName==='VIDEO'){try{pv.pause();}catch{} pv.removeAttribute('src'); pv.load();} else pv.removeAttribute('src'); };
  btn.addEventListener('mouseenter',start); btn.addEventListener('mouseleave',stop); btn.addEventListener('focus',start); btn.addEventListener('blur',stop);
}
function makeCardShell(item){ const b=document.createElement('button'); b.className='thumb thumb--loading'; b.type='button'; const img=document.createElement('img'); img.className='thumb-img'; img.alt=''; img.loading='lazy'; b.appendChild(img); b.addEventListener('click',()=>openFileInStage(item)); b.__img=img; b.__item=item; return b; }
async function loadThumb(btn){ if(btn.__loaded) return; const it=btn.__item, img=btn.__img; try{ const src=isGif(it.url)?await gifThumb(it.url):await videoThumb(it.url); img.src=src; btn.classList.remove('thumb--loading'); attachHoverPreview(btn,it);}catch{ const src=drawFallbackThumb(); img.src=src; btn.classList.remove('thumb--loading'); attachHoverPreview(btn,it);} btn.__loaded=true; }

const $videoGrid=document.getElementById('videoGrid');
let observer=null;
function renderGrid(items){
  if(observer){observer.disconnect();observer=null;}
  $videoGrid.innerHTML='';
  if(!items.length){ $videoGrid.innerHTML='<div class="muted" style="padding:10px 14px">No matches.</div>'; return; }
  observer=new IntersectionObserver((ents)=>{ for(const e of ents){ if(e.isIntersecting && e.target && e.target.__item){ loadThumb(e.target); observer.unobserve(e.target);} } },{root:null,rootMargin:'300px',threshold:0.01});
  items.forEach(it=>{ const card=makeCardShell(it); $videoGrid.appendChild(card); observer.observe(card); });
}

/* ===== tags & filtering ===== */
const $tagsBar=document.getElementById('tagsBar');
const $tagLogic=document.getElementById('tagLogic');
let ALL_TAGS=new Set(), SELECTED_TAGS=new Set(), TAG_LOGIC='and';
function buildTagsUI(){ $tagsBar.innerHTML=''; [...ALL_TAGS].sort((a,b)=>a.localeCompare(b)).forEach(tag=>{ const b=document.createElement('button'); b.type='button'; b.className='tag'; b.textContent=tag; const set=()=>{if(SELECTED_TAGS.has(tag)) b.classList.add('active'); else b.classList.remove('active');}; b.addEventListener('click',()=>{ if(SELECTED_TAGS.has(tag)) SELECTED_TAGS.delete(tag); else SELECTED_TAGS.add(tag); set(); applyFilterAndRender(true); }); set(); $tagsBar.appendChild(b); }); }
function filterByTags(items){ const sel=[...SELECTED_TAGS]; if(!sel.length) return items; return items.filter(it=>{ const set=new Set(it.tags||[]); return TAG_LOGIC==='and'? sel.every(t=>set.has(t)) : sel.some(t=>set.has(t)); }); }
function parseHash(){ const h=new URLSearchParams(location.hash.replace(/^#/,'')); const tags=(h.get('tags')||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean); const logic=(h.get('logic')||'and').toLowerCase(); SELECTED_TAGS=new Set(tags); TAG_LOGIC=(logic==='or'?'or':'and'); $tagLogic.value=TAG_LOGIC; }
function updateHash(){ const tags=[...SELECTED_TAGS]; const qs=new URLSearchParams(); if(tags.length) qs.set('tags',tags.join(',')); if(TAG_LOGIC!=='and') qs.set('logic',TAG_LOGIC); const str=qs.toString(); location.hash=str?('#'+str):''; }
function applyFilterAndRender(updateURL=false){ FILTERED_ITEMS=filterByTags(LIB_ITEMS); renderGrid(FILTERED_ITEMS); if(updateURL) updateHash(); }

/* ===== boot: fetch from DB ===== */
async function fetchJSON(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

(async()=>{
  try{
    // audio: use TITLE in dropdown
    const a = await fetchJSON(API_LIST('audio'));
    const audioItems = (a.items||[]).map(x=>{
      const base = x.filename.split('/').pop();
      const display = (x.title && String(x.title).trim()) || base;
      return { name: display, url: AUDIO_BASE + x.filename };
    }).sort((p,q)=>p.name.localeCompare(q.name,undefined,{numeric:true,sensitivity:'base'}));

    for(let i=$select.options.length-1;i>0;i--) $select.remove(i);
    for(const it of audioItems){
      const opt=document.createElement('option');
      opt.value=it.url;
      opt.textContent=it.name;
      $select.appendChild(opt);
    }

    // videos from DB
    const v = await fetchJSON(API_LIST('video'));
    const items = (v.items||[]).map(x=>{
      const tags = Array.isArray(x.tags)&&x.tags.length ? x.tags.map(t=>String(t).toLowerCase()) : ['untagged'];
      tags.forEach(t=>ALL_TAGS.add(t));
      return {name:x.filename.split('/').pop(), url: VIDEO_BASE + x.filename, tags};
    }).sort((p,q)=>p.name.localeCompare(q.name,undefined,{numeric:true,sensitivity:'base'}));

    LIB_ITEMS = items;
    parseHash(); buildTagsUI(); applyFilterAndRender(false);
  }catch(e){ $err.textContent = 'Load error: ' + (e.message||e); }
})();

$tagLogic.addEventListener('change',()=>{ TAG_LOGIC=$tagLogic.value; applyFilterAndRender(true); });
window.addEventListener('hashchange',()=>{ parseHash(); buildTagsUI(); applyFilterAndRender(false); });
</script>
</body>
</html>
