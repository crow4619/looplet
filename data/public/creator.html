<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Looplet Creator</title>
<link rel="icon" type="image/png" href="looplet.png"/>
<style>
  :root{--bg:#0b0f14;--fg:#e9eef3;--muted:#aab6c4;--card:#101722;--line:#1c2634;--accent:#1367d6;--bad:#ff6868}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b0f14,#0c1117);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:18px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .logo-title{display:flex;align-items:center;gap:10px;min-width:0}
  .logo-title img{height:22px}
  .logo-title h1{font-size:20px;margin:0;white-space:nowrap}
  .navlink a{color:#9ec5ff;text-decoration:none;font-size:14px;white-space:nowrap}

  main{max-width:1200px;margin:20px auto;padding:0 14px 40px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.25);margin-bottom:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  button,select,input[type="file"]{height:40px;border-radius:10px;border:1px solid var(--line);background:#0f1520;color:var(--fg);padding:0 12px}
  button.primary{background:linear-gradient(180deg,#2480ff,#1367d6);border:none;box-shadow:0 6px 18px rgba(19,103,214,.35);font-weight:600}
  button.icon{width:36px;height:36px;padding:0;display:inline-grid;place-items:center;border-radius:9px}
  button.ghost{height:32px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#0f1520;color:var(--fg)}
  input[type="text"], input[type="datetime-local"]{width:100%;background:#0f1520;color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:6px 8px}
  .muted{color:var(--muted);font-size:12px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0f1520;font-size:12px;color:#9ec5ff}
  .hidden{display:none!important}

  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px 10px;border-bottom:1px solid var(--line);vertical-align:top}
  th{color:var(--muted);text-align:left}

  @media (max-width: 820px){
    #table thead{display:none}
    #table tbody tr{display:grid;grid-template-columns:120px 1fr;gap:10px;padding:10px;border-bottom:1px solid var(--line)}
    #table tbody td{border:0;padding:0}
    #table tbody td[data-title]::before{content:attr(data-title);display:block;color:var(--muted);font-size:12px;margin-bottom:4px}
    th.col-preview{width:auto}
  }

  .preview{position:relative;width:120px;aspect-ratio:3/2;border-radius:10px;overflow:hidden;background:#0f1520;border:1px solid var(--line)}
  .preview img,.preview video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
  .preview .static{opacity:1;transition:opacity .18s ease}
  .preview .live{opacity:0;transition:opacity .18s ease;pointer-events:none}
  .preview:hover .static,.preview:focus-within .static{opacity:0}
  .preview:hover .live,.preview:focus-within .live{opacity:1}
  .preview .badge{position:absolute;right:6px;bottom:6px;font-size:10px;color:#e9eef3;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18);padding:2px 6px;border-radius:999px;letter-spacing:.2px}
  th.col-preview{width:130px}

  .aprev{width:120px}
  .aprev audio{width:100%; height:32px}

  tr.dirty{border-left:3px solid var(--accent)}
</style>
</head>
<body>
<header>
  <div class="logo-title"><img src="looplet.png" alt=""/><h1>Looplet Creator</h1></div>
  <div class="navlink"><a href="index.html">→ Viewer</a></div>
</header>

<main>

  <!-- Import -->
  <section class="card">
    <div class="row" style="gap:12px">
      <strong>Import</strong>
      <button id="btnScan" class="primary">Scan</button>
      <input id="uploadMixed" type="file" multiple accept=".gif,.mp4,.webm,.mov,.mp3,.flac,.ogg,.wav" style="display:none"/>
      <button id="btnUploadMixed">Upload media…</button>
      <span id="scanInfo" class="muted"></span>
    </div>
  </section>

  <!-- Media Library -->
  <section class="card">
    <div class="row" style="gap:12px">
      <strong>Media Library</strong>

      <span class="muted">Type</span>
      <select id="mediaType">
        <option value="video" selected>Video (animations)</option>
        <option value="audio">Audio</option>
      </select>

      <button id="btnReload">Reload from DB</button>

      <span class="muted">Sort</span>
      <select id="sortField" title="Sort by">
        <option value="filename" selected>Filename</option>
        <option value="title">Title</option>
        <option value="credit">Credit</option>
        <option value="created_at">Date</option>
      </select>
      <button id="sortDir" title="Toggle sort">A→Z</button>

      <button id="btnSaveAll" disabled>Save all changes (0)</button>
    </div>

    <div class="muted" style="margin:6px 0 10px">
      Edit titles, tags (<code>space, night</code> or <code>#space #night</code>), credit, and date. Use <span class="mono">Now</span> to stamp the current time.
      Rows marked with a blue bar and “● Unsaved” have edits not saved to the DB yet.
    </div>

    <div style="overflow:auto;border:1px solid var(--line);border-radius:10px">
      <table id="table">
        <thead>
        <tr>
          <th class="col-preview">Preview</th>
          <th style="width:22%">Filename</th>
          <th style="width:20%">Title</th>
          <th style="width:18%">Tags</th>
          <th style="width:16%">Credit</th>
          <th style="width:12%">Date</th>
          <th style="width:6%">Actions</th>
        </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

</main>

<script>
/* ---------- constants & helpers ---------- */
const VIDEO_BASE='/video/';
const AUDIO_BASE='/audio/';
const IS_VIDEO_RE=/\.(gif|mp4|webm|mov)$/i;
const IS_AUDIO_RE=/\.(mp3|flac|ogg|wav)$/i;

function parseTagsInput(s){
  if(Array.isArray(s)) return s.map(x=>String(x).toLowerCase());
  const out=new Set(); const raw=String(s||'').trim(); if(!raw) return [];
  raw.split(',').forEach(p=>{p=p.trim(); if(p) out.add(p.replace(/^#/,'').toLowerCase());});
  for(const m of raw.matchAll(/(^|[\s_.-])#([\p{L}\p{N}_-]+)/gu)) out.add(m[2].toLowerCase());
  return Array.from(out);
}
function titleFromName(name){ return String(name||'').replace(/\.[^.]+$/,'').replace(/[_-]+/g,' ').replace(/\s+/g,' ').trim(); }
function baseFromFilename(filename){ return String(filename||'').replace(/\.[^.]+$/,''); }
function isGif(url){ return /\.gif(\?|#|$)/i.test(url); }
function isoToLocalDT(iso){ if(!iso) return ""; const d = new Date(iso); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`; }
function localDTToISO(localStr){ if(!localStr) return null; const d=new Date(localStr); if(Number.isNaN(d.getTime())) return null; return d.toISOString(); }

/* thumbnails */
function drawFallbackThumb(){ const c=document.createElement('canvas'); c.width=600; c.height=400; const g=c.getContext('2d'); const grd=g.createLinearGradient(0,0,0,400); grd.addColorStop(0,'#19253a'); grd.addColorStop(1,'#0f1520'); g.fillStyle=grd; g.fillRect(0,0,c.width,c.height); return c.toDataURL('image/png'); }
function gifThumb(url){ return new Promise((res,rej)=>{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ try{ const c=document.createElement('canvas'); const w=img.naturalWidth||600,h=img.naturalHeight||400; c.width=600; c.height=Math.round(h*(c.width/w)); c.getContext('2d').drawImage(img,0,0,c.width,c.height); res(c.toDataURL('image/png')); }catch(e){rej(e)} }; img.onerror=()=>rej(new Error('gif thumb error')); img.src = url + (url.includes('?')?'&':'?') + 't=' + Date.now(); setTimeout(()=>rej(new Error('gif timeout')),8000); }); }
function videoThumb(url){ return new Promise((res,rej)=>{ const v=document.createElement('video'); v.preload='metadata'; v.muted=true; v.crossOrigin='anonymous'; v.src=url; const fail=e=>{try{v.pause();}catch{} v.removeAttribute('src'); v.load(); rej(e||new Error('thumb error'));}; v.addEventListener('loadeddata',()=>{ try{ v.currentTime=Math.min(0.2,(v.duration||1)/5); }catch{} }); v.addEventListener('seeked',()=>{ try{ const c=document.createElement('canvas'); const w=v.videoWidth||600,h=v.videoHeight||400; c.width=600; c.height=Math.round(h*(c.width/w)); c.getContext('2d').drawImage(v,0,0,c.width,c.height); try{v.pause();}catch{} v.removeAttribute('src'); v.load(); res(c.toDataURL('image/jpeg',0.9)); }catch(e){fail(e)} }); v.onerror=fail; setTimeout(()=>fail(new Error('thumb timeout')),6000); }); }

/* API */
async function apiScan(){ const r=await fetch('/api/scan',{method:'POST'}); if(!r.ok) throw new Error('scan failed'); return r.json(); }
async function apiList(kind){ const r=await fetch('/api/media?kind='+encodeURIComponent(kind)); if(!r.ok) throw new Error('list failed'); const j=await r.json(); return j.items||[]; }
async function apiPatch(id,body){ const r=await fetch('/api/media/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!r.ok) throw new Error('save failed'); return r.json(); }
async function apiUpload(files, kind){ const fd = new FormData(); for(const f of files) fd.append('files', f, f.name); const r = await fetch('/api/upload?kind='+encodeURIComponent(kind), { method:'POST', body: fd }); if(!r.ok) throw new Error('upload failed'); return r.json(); }
async function apiDelete(id, deleteFile){ const r = await fetch(`/api/media/${id}?deleteFile=${deleteFile?1:0}`, { method:'DELETE' }); if(!r.ok) throw new Error('delete failed'); return r.json(); }

/* DOM refs */
const $tbody=document.getElementById('tbody');
const $btnScan=document.getElementById('btnScan');
const $scanInfo=document.getElementById('scanInfo');
const $btnReload=document.getElementById('btnReload');
const $mediaType=document.getElementById('mediaType');
const $sortField=document.getElementById('sortField');
const $sortDir=document.getElementById('sortDir');
const $btnUploadMixed=document.getElementById('btnUploadMixed');
const $uploadMixed=document.getElementById('uploadMixed');
const $btnSaveAll=document.getElementById('btnSaveAll');

/* state */
let ROWS=[];
let currentKind='video';
let sortFieldKey='filename';
let sortAscending=true;

/* dirty tracking */
function dirtyCount(){ return ROWS.filter(r=>r._dirty).length; }
function updateSaveAllButton(){
  const n = dirtyCount();
  $btnSaveAll.disabled = n===0;
  $btnSaveAll.textContent = `Save all changes (${n})`;
}
function markDirty(row, tr, yes=true){
  const was = !!row._dirty;
  row._dirty = !!yes;
  if(tr){
    if(row._dirty){
      tr.classList.add('dirty');
      tr.querySelector('.unsaved')?.classList.remove('hidden');
    }else{
      tr.classList.remove('dirty');
      tr.querySelector('.unsaved')?.classList.add('hidden');
    }
  }
  if(was!==row._dirty) updateSaveAllButton();
}

/* sorting */
function labelSortButton(){
  if(sortFieldKey==='created_at'){
    $sortDir.textContent = sortAscending ? 'Old→New' : 'New→Old';
  }else{
    $sortDir.textContent = sortAscending ? 'A→Z' : 'Z→A';
  }
}
function sortRowsInPlace(){
  const dir = sortAscending ? 1 : -1;
  ROWS.sort((a,b)=>{
    if(sortFieldKey==='created_at'){
      const ad = a.created_at ? Date.parse(a.created_at) : 0;
      const bd = b.created_at ? Date.parse(b.created_at) : 0;
      return (ad - bd) * dir;
    }
    const av = (a[sortFieldKey]||'').toString().toLowerCase();
    const bv = (b[sortFieldKey]||'').toString().toLowerCase();
    return av.localeCompare(bv) * dir;
  });
}

/* render */
function clearRows(){ $tbody.innerHTML='<tr><td colspan="7" class="muted">Loading…</td></tr>'; }

function setRows(items){
  ROWS = items.slice();
  sortRowsInPlace();
  if(!ROWS.length){ $tbody.innerHTML='<tr><td colspan="7" class="muted">No rows — try Scan or Upload.</td></tr>'; updateSaveAllButton(); return; }
  $tbody.innerHTML='';
  ROWS.forEach(row=>{
    const tr=document.createElement('tr');

    // Preview
    const tdPrev=document.createElement('td'); tdPrev.setAttribute('data-title','Preview');
    if(currentKind==='video'){
      const wrap=document.createElement('div'); wrap.className='preview'; wrap.tabIndex=0;
      const staticImg=document.createElement('img'); staticImg.className='static'; staticImg.alt='';
      const liveEl=isGif(row.filename)? new Image() : document.createElement('video'); liveEl.className='live';
      if(liveEl.tagName==='VIDEO'){ liveEl.muted=true; liveEl.loop=true; liveEl.playsInline=true; liveEl.preload='metadata'; }
      const badge=document.createElement('div'); badge.className='badge'; badge.textContent=(row.filename.split('.').pop()||'').toLowerCase();
      wrap.appendChild(staticImg); wrap.appendChild(liveEl); wrap.appendChild(badge); tdPrev.appendChild(wrap);

      const url=VIDEO_BASE + row.filename;
      (isGif(url)?gifThumb(url):videoThumb(url))
        .then(src=>{
          staticImg.src=src;
          liveEl.src=url;
          if(liveEl.tagName==='VIDEO'){
            const start=()=>{ try{liveEl.currentTime=Math.min(0.1,(liveEl.duration||1)/10);}catch{} liveEl.play().catch(()=>{}); };
            const stop =()=>{ try{liveEl.pause();}catch{} };
            wrap.addEventListener('mouseenter', start);
            wrap.addEventListener('mouseleave', stop);
            wrap.addEventListener('focus', start);
            wrap.addEventListener('blur',  stop);
          }
        })
        .catch(()=>{ staticImg.src=drawFallbackThumb(); });
    } else {
      const box=document.createElement('div'); box.className='aprev';
      const a=document.createElement('audio'); a.controls=true; a.preload='metadata'; a.src=AUDIO_BASE+row.filename;
      box.appendChild(a); tdPrev.appendChild(box);
    }
    tr.appendChild(tdPrev);

    // helper inputs
    const mk=(title, val, key, ph='')=>{
      const td=document.createElement('td'); td.setAttribute('data-title',title);
      const inp=document.createElement('input'); inp.type='text'; inp.value=val||''; inp.placeholder=ph; td.appendChild(inp);
      inp.addEventListener('input',()=>{ row[key]=inp.value; markDirty(row,tr,true); });
      return td;
    };

    // cells
    const tdName=document.createElement('td'); tdName.setAttribute('data-title','Filename');
    tdName.textContent=row.filename;
    const unsaved=document.createElement('span'); unsaved.className='chip unsaved hidden'; unsaved.textContent='● Unsaved';
    tdName.appendChild(unsaved);

    const tdTitle=mk('Title', row.title || titleFromName(baseFromFilename(row.filename)),'title');
    const tdTags=mk('Tags', Array.isArray(row.tags)? row.tags.join(', ') : '','tags');
    const tdCredit=mk('Credit', row.credit || '','credit');

    const tdDate=document.createElement('td'); tdDate.setAttribute('data-title','Date');
    const dt=document.createElement('input'); dt.type='datetime-local'; dt.value=isoToLocalDT(row.created_at); dt.style.width='calc(100% - 48px)';
    const nowBtn=document.createElement('button'); nowBtn.className='ghost'; nowBtn.style.marginLeft='6px'; nowBtn.textContent='Now';
    tdDate.appendChild(dt); tdDate.appendChild(nowBtn);
    dt.addEventListener('change',()=>{ row.created_at = localDTToISO(dt.value); markDirty(row,tr,true); });
    nowBtn.addEventListener('click',()=>{ const iso=new Date().toISOString(); row.created_at=iso; dt.value=isoToLocalDT(iso); markDirty(row,tr,true); });

    tr.appendChild(tdName);
    tr.appendChild(tdTitle);
    tr.appendChild(tdTags);
    tr.appendChild(tdCredit);
    tr.appendChild(tdDate);

    // actions
    const tdAct=document.createElement('td'); tdAct.setAttribute('data-title','Actions');
    const save=document.createElement('button'); save.className='icon'; save.title='Save to DB'; save.textContent='💾';
    const del=document.createElement('button'); del.className='icon'; del.title='Delete'; del.textContent='🗑';
    tdAct.appendChild(save); tdAct.appendChild(del);
    tr.appendChild(tdAct);
    $tbody.appendChild(tr);

    // wire save / delete
    save.addEventListener('click', async ()=>{
      save.disabled=true;
      try{
        const body={
          title: row.title || titleFromName(baseFromFilename(row.filename)),
          credit: (row.credit||'').trim(),
          created_at: row.created_at || null,
          tags: parseTagsInput(row.tags)
        };
        await apiPatch(row.id, body);
        save.textContent='✅'; setTimeout(()=>save.textContent='💾',800);
        markDirty(row,tr,false);
      }catch(e){ alert('Save failed: '+(e.message||e)); }
      finally{ save.disabled=false; }
    });

    del.addEventListener('click', async ()=>{
      const also = confirm('Delete file from disk too? OK = delete disk + DB, Cancel = DB only.');
      try{ await apiDelete(row.id, also); await loadDB(); }
      catch(e){ alert('Delete failed: ' + (e.message||e)); }
    });
  });

  updateSaveAllButton();
}

/* load helpers */
async function loadDB(){
  clearRows();
  try{
    const items=await apiList(currentKind);
    const rows=items.map(v=>({
      id:v.id, kind:v.kind, filename:v.filename,
      title:v.title||'', tags:Array.isArray(v.tags)?v.tags.slice():[],
      credit:v.credit||'', created_at: v.created_at || null,
      _dirty:false
    }));
    setRows(rows);
  }catch(e){
    $tbody.innerHTML='<tr><td colspan="7" class="muted" style="color:#ff9b9b">Load failed: '+(e.message||e)+'</td></tr>';
    updateSaveAllButton();
  }
}

/* events */
$btnScan.addEventListener('click', async ()=>{
  $btnScan.disabled=true; $scanInfo.textContent='Scanning…';
  try{ await apiScan(); $scanInfo.textContent='Scan complete.'; await loadDB(); }
  catch(e){ $scanInfo.textContent='Scan failed: '+(e.message||e); }
  finally { $btnScan.disabled=false; }
});

$btnReload.addEventListener('click', loadDB);

$mediaType.addEventListener('change', ()=>{ currentKind=$mediaType.value; loadDB(); });

$sortField.addEventListener('change', ()=>{ sortFieldKey = $sortField.value; labelSortButton(); sortRowsInPlace(); setRows(ROWS); });
$sortDir.addEventListener('click', ()=>{ sortAscending = !sortAscending; labelSortButton(); sortRowsInPlace(); setRows(ROWS); });

$btnUploadMixed.addEventListener('click', ()=> $uploadMixed.click());
$uploadMixed.addEventListener('change', async ()=>{
  const files = Array.from($uploadMixed.files||[]);
  if(!files.length) return;
  $btnUploadMixed.disabled = true;
  $scanInfo.textContent = 'Uploading…';
  try{
    const vids = files.filter(f=>IS_VIDEO_RE.test(f.name));
    const auds = files.filter(f=>IS_AUDIO_RE.test(f.name));
    if(vids.length) await apiUpload(vids,'video');
    if(auds.length) await apiUpload(auds,'audio');
    $scanInfo.textContent = 'Upload complete.';
    await loadDB();
  }catch(e){
    alert('Upload failed: ' + (e.message||e));
    $scanInfo.textContent = 'Upload failed.';
  }finally{
    $btnUploadMixed.disabled = false;
    $uploadMixed.value = '';
  }
});

/* Save all */
$btnSaveAll.addEventListener('click', async ()=>{
  const dirty = ROWS.filter(r=>r._dirty);
  if(!dirty.length) return;
  $btnSaveAll.disabled = true;
  $btnSaveAll.textContent = `Saving… (0/${dirty.length})`;
  let i=0, ok=0, fail=0;
  for(const row of dirty){
    try{
      const body={
        title: row.title || titleFromName(baseFromFilename(row.filename)),
        credit: (row.credit||'').trim(),
        created_at: row.created_at || null,
        tags: parseTagsInput(row.tags)
      };
      await apiPatch(row.id, body);
      row._dirty=false; ok++;
      const tr = Array.from($tbody.children).find(tr => tr.querySelector('[data-title="Filename"]')?.firstChild?.nodeValue === row.filename);
      if(tr) markDirty(row,tr,false);
    }catch(e){
      console.warn('Save-all failed for', row.filename, e);
      fail++;
    }finally{
      i++;
      $btnSaveAll.textContent = `Saving… (${i}/${dirty.length})`;
    }
  }
  await loadDB();
  $btnSaveAll.textContent = fail ? `Done (${ok} saved, ${fail} failed)` : 'All changes saved';
  setTimeout(updateSaveAllButton, 1200);
});

/* initial load */
function labelSortButton(){ if(sortFieldKey==='created_at'){$sortDir.textContent = sortAscending ? 'Old→New' : 'New→Old';} else {$sortDir.textContent = sortAscending ? 'A→Z' : 'Z→A';} }
labelSortButton();
document.addEventListener('DOMContentLoaded', ()=>{ currentKind='video'; $mediaType.value='video'; loadDB(); });
</script>
</body>
</html>
