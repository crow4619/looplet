<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Looplet Creator</title>
<link rel="icon" type="image/png" href="looplet.png"/>
<style>
  :root{
    --bg:#0b0f14; --fg:#e9eef3; --muted:#aab6c4; --card:#101722; --line:#1c2634;
    --accent:#1367d6; --bad:#ff6868; --good:#71ea9a;

    /* fixed column widths (header/body share these) */
    --col-prev:   140px;
    --col-name:   360px;
    --col-title:  260px;
    --col-tags:   220px;
    --col-credit: 200px;
    --col-date:   240px;
    --col-actions:160px;

    --table-min: calc(var(--col-prev) + var(--col-name) + var(--col-title) + var(--col-tags) + var(--col-credit) + var(--col-date) + var(--col-actions));
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b0f14,#0c1117);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

  header{padding:18px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .logo-title{display:flex;align-items:center;gap:10px;min-width:0}
  .logo-title img{height:22px}
  .logo-title h1{font-size:20px;margin:0;white-space:nowrap}
  .navlink a{color:#9ec5ff;text-decoration:none;font-size:14px;white-space:nowrap}

  main{max-width:1200px;margin:20px auto;padding:0 14px 40px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.25);margin-bottom:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .stack{display:grid;gap:10px}

  button,select,input[type="file"]{height:40px;border-radius:10px;border:1px solid var(--line);background:#0f1520;color:var(--fg);padding:0 12px}
  button.primary{background:linear-gradient(180deg,#2480ff,#1367d6);border:none;box-shadow:0 6px 18px rgba(19,103,214,.35);font-weight:600}
  button.icon{width:36px;height:36px;padding:0;display:inline-grid;place-items:center;border-radius:9px}
  input[type="text"], input[type="datetime-local"]{width:100%;background:#0f1520;color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:6px 8px;height:36px}
  .muted{color:var(--muted);font-size:12px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0f1520;font-size:12px}
  .badge.unsaved{border-color:#ffd27a;box-shadow:0 0 0 1px #ffd27a33 inset}
  .ok{color:var(--good)} .err{color:#ff9b9b}

  .table-card{padding:0}
  .controls{position:sticky;top:0;z-index:3;padding:14px;border-bottom:1px solid var(--line);background:var(--card);border-top-left-radius:14px;border-top-right-radius:14px}
  .controls .row{gap:12px}
  .hint{padding:0 14px 10px;color:var(--muted);font-size:12px}

  .table-wrap{
    position:relative;
    overflow:auto;                 /* both directions */
    max-height:65vh;
    border-top:1px solid var(--line);
    border-bottom-left-radius:14px;border-bottom-right-radius:14px;
  }
  .table{min-width:var(--table-min)}

  /* sticky header IN the scroll container â†’ it naturally scrolls horizontally with content */
  .table-head{position:sticky;top:0;z-index:2;background:#0f1520;border-bottom:1px solid var(--line)}

  /* identical grid for head + rows */
  .hdr,.rowgrid{
    display:grid;
    grid-template-columns:
      var(--col-prev)
      var(--col-name)
      var(--col-title)
      var(--col-tags)
      var(--col-credit)
      var(--col-date)
      var(--col-actions);
    gap:0; align-items:center;
  }
  .hdr > div{padding:10px 12px;color:var(--muted);font-size:13px;background:#0f1520;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .tbody .rowgrid{border-bottom:1px solid var(--line)}
  .tbody .rowgrid > div{padding:10px 12px}

  /* wrap text, but never change the column width */
  .wrap{overflow-wrap:anywhere;word-break:break-word;white-space:normal}

  /* preview */
  .preview{position:relative;width:120px;aspect-ratio:3/2;border-radius:10px;overflow:hidden;background:#0f1520;border:1px solid var(--line)}
  .preview img,.preview video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
  .preview .static{opacity:1;transition:opacity .18s ease}
  .preview .live{opacity:0;transition:opacity .18s ease;pointer-events:none}
  .preview:hover .static,.preview:focus-within .static{opacity:0}
  .preview:hover .live,.preview:focus-within .live{opacity:1}
  .preview .ext{position:absolute;right:6px;bottom:6px;font-size:10px;color:#e9eef3;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18);padding:2px 6px;border-radius:999px}

  .actions{display:flex;gap:8px;align-items:center}
  .danger{border-color:#4a1d1f !important;background:#1a0f11 !important}
  .danger:hover{border-color:#7a2b2f !important}

  @media (max-width:900px){
    :root{ --col-name:320px; --col-title:220px; --col-tags:200px; --col-credit:180px; --col-date:220px; }
  }
</style>
</head>
<body>
<header>
  <div class="logo-title"><img src="looplet.png" alt=""/><h1>Looplet Creator</h1></div>
  <div class="navlink"><a href="index.html">â†’ Viewer</a></div>
</header>

<main>
  <!-- Import -->
  <section class="card">
    <div class="row">
      <strong>Import</strong>
      <button id="btnScan" class="primary">Scan</button>
      <input id="uploadPicker" type="file" multiple accept=".gif,.mp4,.webm,.mov,.mp3,.flac,.ogg,.wav" style="display:none"/>
      <button id="btnUpload">Upload mediaâ€¦</button>
      <span id="importInfo" class="muted"></span>
    </div>
  </section>

  <!-- Media Library -->
  <section class="card table-card">
    <div class="controls">
      <div class="row" style="justify-content:space-between;gap:14px">
        <div class="row">
          <strong>Media Library</strong>
          <span class="muted">Type</span>
          <select id="typeSelect" title="Media type">
            <option value="video">Video (animations)</option>
            <option value="audio">Audio</option>
          </select>
          <button id="btnReload">Reload from DB</button>
        </div>
        <div class="row">
          <span class="muted">Sort</span>
          <select id="sortField">
            <option value="filename">Filename</option>
            <option value="title">Title</option>
            <option value="credit">Credit</option>
            <option value="created_at">Date</option>
          </select>
          <select id="sortDir">
            <option value="asc">Aâ†’Z</option>
            <option value="desc">Zâ†’A</option>
          </select>
          <button id="btnSaveAll">Save all changes</button>
        </div>
      </div>
    </div>

    <div class="hint">
      Edit titles, tags (<code>space</code>, <code>night</code> or <code>#space #night</code>), credit, and date.
      Click ðŸ’¾ to save a row, ðŸ—‘ to delete (optionally remove the file too). Thumbnails load only for visible rows.
      <span id="status" class="muted"></span>
    </div>

    <div id="tableWrap" class="table-wrap" aria-live="polite">
      <div class="table">
        <div class="table-head">
          <div id="headGrid" class="hdr">
            <div>Preview</div>
            <div>Filename</div>
            <div>Title</div>
            <div>Tags</div>
            <div>Credit</div>
            <div>Date</div>
            <div>Actions</div>
          </div>
        </div>
        <div id="tbody" class="tbody">
          <div style="padding:12px 14px" class="muted">Loadingâ€¦</div>
        </div>
        <div id="sentinel" style="height:24px"></div>
      </div>
    </div>
  </section>
</main>

<script>
/* ===== API ===== */
const API = {
  scan: () => fetch('/api/scan',{method:'POST'}).then(r=>r.json()),
  upload: (files) => { const fd=new FormData(); for(const f of files) fd.append('files',f,f.name); return fetch('/api/upload',{method:'POST',body:fd}).then(r=>r.json()); },
  list: (kind) => fetch('/api/media?kind='+encodeURIComponent(kind)).then(r=>r.json()).then(j=>j.items||[]),
  patch: (id,body) => fetch('/api/media/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json()),
  del: (id,alsoFile) => fetch('/api/delete/'+id+'?file='+(alsoFile?'1':'0'),{method:'DELETE'}).then(r=>r.json())
};
const VIDEO_BASE='/video/', AUDIO_BASE='/audio/';
const isGif = u => /\.gif(\?|#|$)/i.test(u);
const drawFallbackThumb=()=>{const c=document.createElement('canvas');c.width=600;c.height=400;const g=c.getContext('2d');const d=g.createLinearGradient(0,0,0,400);d.addColorStop(0,'#19253a');d.addColorStop(1,'#0f1520');g.fillStyle=d;g.fillRect(0,0,c.width,c.height);return c.toDataURL('image/png');};
function gifThumb(url){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin='anonymous';i.onload=()=>{try{const c=document.createElement('canvas');const w=i.naturalWidth||600,h=i.naturalHeight||400;c.width=600;c.height=Math.round(h*(c.width/w));c.getContext('2d').drawImage(i,0,0,c.width,c.height);res(c.toDataURL('image/png'));}catch(e){rej(e)}};i.onerror=()=>rej(new Error('gif'));i.src=url+(url.includes('?')?'&':'?')+'t='+Date.now();setTimeout(()=>rej(new Error('gif timeout')),8000);});}
function videoThumb(url){return new Promise((res,rej)=>{const v=document.createElement('video');v.preload='metadata';v.muted=true;v.playsInline=true;v.crossOrigin='anonymous';v.src=url;let t=setTimeout(()=>fail(new Error('timeout')),10000);const clean=()=>{v.onerror=null;v.onloadedmetadata=null;v.onseeked=null;clearTimeout(t)};const fail=e=>{try{v.pause()}catch{}v.removeAttribute('src');v.load();clean();rej(e||new Error('thumb'))};const grab=()=>{const c=document.createElement('canvas');const w=v.videoWidth||600,h=v.videoHeight||400;if(!w||!h) throw new Error('nodim');c.width=600;c.height=Math.round(h*(c.width/w));c.getContext('2d').drawImage(v,0,0,c.width,c.height);clean();res(c.toDataURL('image/jpeg',0.9))};v.onerror=()=>fail(new Error('video'));v.onloadedmetadata=()=>{const tSec=Math.min(2,Math.max(0.15,(v.duration||2)*0.15));v.onseeked=()=>{try{grab()}catch(e){fail(e)}};try{v.currentTime=tSec}catch{fail(new Error('seek'))}}});}

/* ===== DOM ===== */
const $btnScan=document.getElementById('btnScan');
const $btnUpload=document.getElementById('btnUpload');
const $uploadPicker=document.getElementById('uploadPicker');
const $importInfo=document.getElementById('importInfo');

const $type=document.getElementById('typeSelect');
const $btnReload=document.getElementById('btnReload');
const $sortField=document.getElementById('sortField');
const $sortDir=document.getElementById('sortDir');
const $btnSaveAll=document.getElementById('btnSaveAll');

const $tableWrap=document.getElementById('tableWrap');
const $tbody=document.getElementById('tbody');
const $sentinel=document.getElementById('sentinel');
const $status=document.getElementById('status');

/* ===== State ===== */
let KIND='video';
let ALL_ITEMS=[]; let VISIBLE_ROWS=[]; let PAGE=0;
const PAGE_SIZE=40;
let observerRows=null, observerPager=null;
let dirty=new Map();

/* ===== Utils ===== */
function parseTagsInput(s){ if(Array.isArray(s)) return s.map(x=>String(x).toLowerCase()); const out=new Set(); const raw=String(s||'').trim(); if(!raw) return []; raw.split(',').forEach(p=>{p=p.trim(); if(p) out.add(p.replace(/^#/,'').toLowerCase())}); for(const m of raw.matchAll(/(^|[\s_.-])#([\p{L}\p{N}_-]+)/gu)) out.add(m[2].toLowerCase()); return Array.from(out); }
const titleFromName=n=>String(n||'').replace(/\.[^.]+$/,'').replace(/[_-]+/g,' ').replace(/\s+/g,' ').trim();
const baseFromFilename=fn=>String(fn||'').replace(/\.[^.]+$/,'');
function markDirty(id,row,label){ dirty.set(id,true); if(label) label.style.display=''; }
function clearDirty(id,row,label){ dirty.delete(id); if(label) label.style.display='none'; }

/* ===== Row builder ===== */
function makeRow(item){
  const row=document.createElement('div'); row.className='rowgrid'; row.dataset.id=item.id;

  const cPrev=document.createElement('div');
  if(KIND==='video'){
    const wrap=document.createElement('div'); wrap.className='preview'; wrap.tabIndex=0;
    const staticImg=document.createElement('img'); staticImg.className='static'; staticImg.alt='';
    const liveEl=isGif(item.filename)? new Image() : document.createElement('video'); liveEl.className='live';
    if(liveEl.tagName==='VIDEO'){ liveEl.muted=true; liveEl.loop=true; liveEl.playsInline=true; liveEl.preload='metadata'; }
    const badge=document.createElement('div'); badge.className='ext'; badge.textContent=(item.filename.split('.').pop()||'').toLowerCase();
    wrap.appendChild(staticImg); wrap.appendChild(liveEl); wrap.appendChild(badge); cPrev.appendChild(wrap);
    row.__thumbLoad=async()=>{ const url=VIDEO_BASE+item.filename; try{ const src=isGif(url)?await gifThumb(url):await videoThumb(url); staticImg.src=src; if(liveEl.tagName==='VIDEO'){ liveEl.src=url; const start=()=>{ try{liveEl.currentTime=0.12;}catch{} liveEl.play().catch(()=>{})}; const stop=()=>{ try{liveEl.pause()}catch{} }; wrap.addEventListener('mouseenter',start); wrap.addEventListener('mouseleave',stop); wrap.addEventListener('focus',start); wrap.addEventListener('blur',stop); } else liveEl.src=url; }catch{ staticImg.src=drawFallbackThumb(); } };
  } else { cPrev.textContent='â€”'; }

  const cName=document.createElement('div'); cName.className='wrap'; cName.textContent=item.filename;

  const cTitle=document.createElement('div'); const iTitle=document.createElement('input'); iTitle.type='text'; iTitle.value=item.title||titleFromName(baseFromFilename(item.filename)); cTitle.appendChild(iTitle);
  const cTags=document.createElement('div'); const iTags=document.createElement('input'); iTags.type='text'; iTags.value=(Array.isArray(item.tags)?item.tags.join(', '):''); cTags.appendChild(iTags);
  const cCred=document.createElement('div'); const iCred=document.createElement('input'); iCred.type='text'; iCred.value=item.credit||''; cCred.appendChild(iCred);

  const cDate=document.createElement('div'); const iDate=document.createElement('input'); iDate.type='datetime-local';
  const dt=item.created_at?new Date(item.created_at):null; if(dt&&!isNaN(dt)){ const local=new Date(dt.getTime()-dt.getTimezoneOffset()*60000).toISOString().slice(0,16); iDate.value=local; }
  cDate.appendChild(iDate);
  const btnNow=document.createElement('button'); btnNow.className='icon'; btnNow.title='Set to now'; btnNow.textContent='ðŸ•’';
  btnNow.addEventListener('click',()=>{const now=new Date(); const local=new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,16); iDate.value=local; markDirty(item.id,row,labelUnsaved);});
  cDate.appendChild(btnNow);

  const cAct=document.createElement('div'); cAct.className='actions';
  const labelUnsaved=document.createElement('span'); labelUnsaved.className='badge unsaved'; labelUnsaved.textContent='Unsaved'; labelUnsaved.style.display='none';
  const btnSave=document.createElement('button'); btnSave.className='icon'; btnSave.title='Save to DB'; btnSave.textContent='ðŸ’¾';
  const btnDel=document.createElement('button'); btnDel.className='icon danger'; btnDel.title='Delete from DB (optionally remove file)'; btnDel.textContent='ðŸ—‘';
  cAct.appendChild(labelUnsaved); cAct.appendChild(btnSave); cAct.appendChild(btnDel);

  row.appendChild(cPrev); row.appendChild(cName); row.appendChild(cTitle); row.appendChild(cTags); row.appendChild(cCred); row.appendChild(cDate); row.appendChild(cAct);

  [iTitle,iTags,iCred,iDate].forEach(inp=>inp.addEventListener('input',()=>markDirty(item.id,row,labelUnsaved)));

  btnSave.addEventListener('click', async ()=>{ btnSave.disabled=true; try{ const body={ title:iTitle.value.trim(), tags:parseTagsInput(iTags.value), credit:iCred.value.trim(), created_at:iDate.value?new Date(iDate.value).toISOString():null }; await API.patch(item.id,body); clearDirty(item.id,row,labelUnsaved); btnSave.textContent='âœ…'; setTimeout(()=>btnSave.textContent='ðŸ’¾',800);}catch(e){alert('Save failed: '+(e.message||e))}finally{btnSave.disabled=false;}});
  btnDel.addEventListener('click', async ()=>{ const also=confirm('Delete this row from DB and remove the file from disk?\nOK = delete DB + file\nCancel = delete DB only'); btnDel.disabled=true; try{ await API.del(item.id,also); row.remove(); dirty.delete(item.id);}catch(e){alert('Delete failed: '+(e.message||e))}finally{btnDel.disabled=false;}});
  row.__collectPayload=()=>({ id:item.id, body:{ title:iTitle.value.trim(), tags:parseTagsInput(iTags.value), credit:iCred.value.trim(), created_at:iDate.value?new Date(iDate.value).toISOString():null }, labelUnsaved });
  return row;
}

/* ===== render + paging ===== */
function resetTable(){ $tbody.innerHTML=''; VISIBLE_ROWS=[]; PAGE=0; if(observerRows){observerRows.disconnect();observerRows=null;} if(observerPager){observerPager.disconnect();observerPager=null;} }
function sortItems(){ const f=$sortField.value; const d=$sortDir.value==='desc'?-1:1; ALL_ITEMS.sort((a,b)=>{ let av,bv; if(f==='created_at'){ av=a.created_at?Date.parse(a.created_at):0; bv=b.created_at?Date.parse(b.created_at):0; } else { av=(a[f]||'').toString().toLowerCase(); bv=(b[f]||'').toString().toLowerCase(); } if(av<bv) return -1*d; if(av>bv) return 1*d; return 0; }); }
function renderNextPage(){ const start=PAGE*PAGE_SIZE, end=Math.min(start+PAGE_SIZE,ALL_ITEMS.length); if(start>=end) return;
  const frag=document.createDocumentFragment(); for(let i=start;i<end;i++){ const row=makeRow(ALL_ITEMS[i]); frag.appendChild(row); VISIBLE_ROWS.push(row); } $tbody.appendChild(frag); PAGE++;
  if(!observerRows){ observerRows=new IntersectionObserver((ents)=>{ for(const e of ents){ if(e.isIntersecting && e.target.__thumbLoad){ e.target.__thumbLoad(); observerRows.unobserve(e.target);} } },{root:$tableWrap,rootMargin:'200px 0px',threshold:0.01}); }
  if(KIND==='video'){ for(let i=start;i<end;i++){ observerRows.observe(VISIBLE_ROWS[i]); } }
}
function setupPager(){ if(observerPager){observerPager.disconnect();observerPager=null;} observerPager=new IntersectionObserver((ents)=>{ for(const e of ents){ if(e.isIntersecting) renderNextPage(); } },{root:$tableWrap,rootMargin:'200px 0px',threshold:0}); observerPager.observe($sentinel); }
async function loadKind(kind){ KIND=kind; resetTable(); $status.textContent=''; try{ const list=await API.list(KIND); ALL_ITEMS=list.map(x=>({ id:x.id, filename:x.filename, title:x.title||'', tags:Array.isArray(x.tags)?x.tags.slice():[], credit:x.credit||'', created_at:x.created_at||null })); sortItems(); renderNextPage(); setupPager(); }catch(e){ $tbody.innerHTML='<div style="padding:12px 14px" class="err">Load failed: '+(e.message||e)+'</div>'; }}

/* ===== controls ===== */
$type.addEventListener('change',()=>loadKind($type.value==='audio'?'audio':'video'));
$btnReload.addEventListener('click',()=>loadKind(KIND));
$sortField.addEventListener('change',()=>{sortItems();resetTable();renderNextPage();setupPager();});
$sortDir.addEventListener('change',()=>{sortItems();resetTable();renderNextPage();setupPager();});
$btnSaveAll.addEventListener('click', async ()=>{ if(dirty.size===0){alert('No changes to save.');return;} $btnSaveAll.disabled=true; try{ const ops=[]; for(const row of VISIBLE_ROWS){ const id=Number(row.dataset.id); if(!dirty.has(id)) continue; const {id:rid,body,labelUnsaved}=row.__collectPayload(); ops.push(API.patch(rid,body).then(()=>clearDirty(rid,row,labelUnsaved))); } await Promise.allSettled(ops); $status.innerHTML='<span class="ok">All changes saved.</span>'; setTimeout(()=>{$status.textContent='';},1500); }catch(e){ alert('Save all failed: '+(e.message||e)); }finally{$btnSaveAll.disabled=false;} });

/* ===== import actions ===== */
$btnScan.addEventListener('click', async ()=>{ $btnScan.disabled=true; $importInfo.textContent='Scanningâ€¦'; try{ await API.scan(); $importInfo.textContent='Scan complete.'; await loadKind(KIND); }catch(e){ $importInfo.textContent='Scan failed: '+(e.message||e); }finally{ $btnScan.disabled=false; }});
$btnUpload.addEventListener('click',()=> $uploadPicker.click());
$uploadPicker.addEventListener('change', async ()=>{ const files=Array.from($uploadPicker.files||[]); if(!files.length) return; $btnUpload.disabled=true; $importInfo.textContent='Uploadingâ€¦'; try{ await API.upload(files); $importInfo.textContent='Upload complete.'; await loadKind(KIND); }catch(e){ alert('Upload failed: '+(e.message||e)); $importInfo.textContent='Upload failed.'; }finally{ $btnUpload.disabled=false; $uploadPicker.value=''; }});

/* ===== boot ===== */
(function init(){ $type.value='video'; loadKind('video'); })();
</script>
</body>
</html>